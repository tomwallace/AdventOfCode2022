namespace AdventOfCode2022.CSharp.Seventeen;

public class DaySeventeen : IAdventProblemSet
{
    public readonly string ActualInput = "><<<<>><<<<>>>><>>><<<<>>>><<<>>><<<>>>><<>>><<<<><<<<>>>><<<>><>><>>>><<>><<<><<>><<<<>>>><<>>><<<>>>><<<<>>><<<>>><<<<>>>><<<<><>><>>><<>>>><><<>><<>>>><<>>><<<>><<<<>>><<>>>><>>>><<<>>>><<<<>><>><<<<>><>>><<>>><>>>><<<<>>><<>>><<<><<<><>><<<<>>><<<<>><<<<><<>>><>>><<>>>><<<<>>>><<<>>><<<><>>>><<<<>><<<<>><>>>><<<>>><>>>><>><<<<>>>><<<<>><<>>><<>>>><<<>><<<<><<<<><<<>>>><>>><>><<>><>>><<<>>><<<>>>><<>>>><><<<<>>><<<<>>><<<>>><>>>><<<>>><>>><<<<>><<<<>>>><><<<>>>><<<>>><<<<><<<<>>><>><<><>>>><<<<>><>><<<<>>><>>><<>>>><>>>><<<>>><<<<>>><<>>><><<>>><>>><<<>>>><>><<<><<<><>>><<><<<>>>><<<<>>><<<>><<<>><<<<>><>>><<<><<<>>><<<><<<<><<>><<><>>>><<>>><<<<><<<>>>><<><<<<>>><<>>>><<<<>><<>>>><<>>><<<><<<>><<<>>><<>><<>>><<>><<>><<<><<<<>>><><<<<>>><<<<>>><>>><<<<>><<><<<<><<<<>>>><<>><<>>><<<<>><>><<<<><>>><<<>>>><<<><<>>><<>><<>>><<<>>><<>>>><<>><<<>>>><<>>>><<>>>><><<<<><<<<><<<<>>>><>>>><<>>>><>><<<>>>><<<>>><<<<>><<<<>>>><<<<>><<<>>><<<>>>><<<>>><<<<><<<>>><<><>>>><>><>>>><<><<<<><<<<>><<<<>>>><>>>><>><<>><<<><<<><<<>><<<>>><>>>><>><<>><<<<>>>><>>>><<<<>>>><<>>><<<>><>><<>>><<<<>>>><>>>><<<<>>>><>>><<<>>>><<<>><<<<>>><<<>>><<>>><<<<>>>><<<><<<>>><<<<>><<<<><>>>><<<>>><<<<>><<>><<<<><<<<>>>><>>><><<<>>><<<>>><>><<>>><>>><><<<>><<<<>>><<<><<<>><<<<><<<<><>>>><<<><<>><>>>><<>>>><><<>><<>>>><<>>><<<<>><<<<>>>><>>><<>><<<<><<<<>>>><<>><<<>>>><<>>>><<<>>><<<>>><<<<><<>>><<<>><<<>><<<<>>><>>>><<<<>>><>>>><<<<>><<>>><<<>>>><<>><>>><<<<>>>><<<>>><<<<><>>><<><<><<>>>><<>><<>>><<<<>>><><>>><>><<<<>>>><>>>><<<><><<>>>><<<<>>><<<<>>>><>>>><<><><><>><<><<>>><<>>><<<>>>><<<><<<>><<>>>><>>>><><<<<><<<<>><<>><<><<<>>>><<<<>>>><>>><<<>>><>><><<<>>><<>>>><<<><>>>><<<>><>><<<>><<<<>>><>>>><<><<<<><<<>><<<><>>><<<<>>><<>>><<<<>><<><<<>>>><<<>><<<>>>><<><<<><>><<<><<<>><<<<><>>><<<<><>><<<><<>><<>>>><>>><>><><<<<>>><<<<>><<<>>><<><<<<>>>><<<<>><><<><<><<<><<<>>>><<>><<>>><<>><<<>>><<<<>>><<<<>><<<>>>><<<>>>><>>>><<<<><><<<<>><<>>>><>><<<<>><>>>><<>>><<<><<<>><<<>><<<>>>><<>>>><<<>>><>>>><<>>>><<>><<<<>>>><<<>>>><<><<<>>>><<>>><<>>>><>><<<<><<>>><<<>>><<<<>><<><<<>>>><>><<>>><<<><<><<<><<<><<>>><<<<>>><<<<><<><>><>>>><>>>><<<>><<<>>>><<<<>>><<>>><<>>>><<<<>>><<>>><<<<>>><<<<>>>><<<<>>><><>><<<<><<<<>>><<<>>><<<><>><>><<<<><<<<>><<><<>>>><>>>><<<>><<<<>>>><<>><<<<>>><><<>>><>>><<<><>>><<<><<<<><<<>><>>>><><<<<>>>><<><<<><<<<>><>>>><<><<<<>>><>>><<<>>><<<<><<<>>>><>>>><<<>>><<>><>>>><<>>><<><>>><<<<><<<<>>>><<>>><<>><<<>>><<><<>>>><><<<<>>><<<<><>>>><>>><<<><><<<<>><<>>><<<<>>>><><<><<<<>><<<>><<>>><><<<<><<<<><>>><<>>><>><<<>><<><<<>>>><<<>>>><<<>>>><>>>><>>>><<<><<>>>><><<<<><>>>><<<>>><<<><<<<><<<>><<><<>>><<<><><><<<>>>><<<<>>>><<>><<<>><<>>><><<<<>><<>>>><>>><<<<>><<<<>><<<>>><<<>>>><<><><<<>><<<<>><<<<>>><><>><<<<>><>>><<<<><<<><<<>><>><<<><>>>><<<><<>><<<>>>><<<<><<<<><<<>><<>>><<>>>><<>><<<>>>><<>>><<<><<>>><<>><<>>>><<<<>>><<><<<<>>>><<<<>>><<<>>><<<>>>><<>><<<<><><<<<>>>><>><>><>>><<<<>><<<<>><<><>><<<<>><<<>>><>><<<>><>>><<><<<>>>><><<<<><<<>>>><<<>><>><>><<>><<<>><<<<>>><>>>><<<>>>><<<<>>><>>>><<<<>>><>>><<>><<><<<<><<<>><<>><<<<>>><<>>><<>>><<<<>>><<<>><>>>><<<>><<<<>>>><<>>>><>>>><<<<>><>>><<>>><>>><<>>><<<><<<<><>><<<<><><<<<><>>><<<<>><<<>>><<<>><<<><<<<>>>><><>><<<>>><><<<<>><<>>><>>>><><>>>><><<<>>><<><>>>><><<<<><<<<>><<>><<<<><<<>>>><>>><<>>><>><<<<>>><<>>><<>>><<<<>>><<<><>>><><<<<>>>><<<>>>><>>>><<<<>><<<>><<<>><<<<>><<<<>>>><<><>>>><>>><>>><<<<>>><<<>>><<<<>>>><<<>>>><<>><<<<>><<<>>>><<<><<<>>><<<<><<<<>><>><<>>><><<<<>>><>><<<>>>><<>>>><<<<>>><<><<>>><<<<>>><<<>><<<<>><<>>>><<<<>>>><<<<>>>><<>>>><>>><<<>>><<<<>>>><<><<>><<<<>><<<>>>><<>><<<>>>><>>><<<<>>><><>>><<>><<<>>><<<<><<<<><<><<<<>>><<<><<<<>><<<>><>><>>><>>><<<<>>>><<<>>>><<<>>><>>><><<<<>>><<<>><<>>><<<>>><<<><<<><>><<<>>>><<<>>>><<<<><><<<>><<<>>><<<>>>><<<<>>>><<<<><>><>>><<>>><<<<><<<<>>><<><<<>>><<><<<<><<>>><<>>><>>>><<>>><><><<<><><><<>>><>><<<<>><<<<><>><<<<>>>><<><<<><<>>>><><<<<>><><>><<<<><<<>>><<><<<>><<>><<<>><<<>><<><<<>>>><>>><<<>><<>><<<<>><<<><<>>><<<<><<>>>><>><<>><<<>>><<>>>><<><><<<<><>><<>>>><><<>>>><<<>>>><<<<>>>><>>><><<<>>>><>><<<>><<<<>>><>>>><<><<<>>>><>>><<>><<<>>><<<>>>><<>>><<<><<<>>><<<<>><<<><<>>>><><<<>>>><<<<>>>><<><<<<><><<>>><<<>>><<<><<<>><<<<>>><<>><>>>><<<><>>>><<<><><>>><<<>>><<<<>><<><<<>><<>><<<<>>><<<>><<>>><<<<>>>><<<>><<<<>>>><<<><<>><<<>>>><<>>>><<<<>>><>>><<><<><<<>>><>><>>>><<<><<<><<>><<>>><>><<<><<<<>>><><<>>>><>>>><>>><<<<>><<><<<>>>><>>><<>>><<<><<<<>>><<>>><<<<>><<<><<>>>><>>>><<<>><<<<>>>><<<><>>>><<<<>>><<<<>>><<>><<>><<<<><<<<><<<<>>><>>><<<>>>><<><<<><<<<>>>><<<<>>><<<<>><<<>>>><<<<><<>>><<>><>><<>><><<<>><>>>><><<><<<>>>><<<<>>><>><<<<>>><>>><<>>>><<>>>><<<>><<>>><<><<<<>>><<>>><>>>><<<>>>><<>>><><<<>>>><<<<>>><<<<><<<<><><<><>>><><<>>><><<<<>><<<<>>><<<>><<>>>><<<<>>><<<><<<><>>><<<<><<<<><<>>><<><<>>>><<<<>>><><<><<<><<<<>>>><<><<>><><>>><<<>><<><<<<>>><<><<<<><<<<>><<>>>><<>>>><<>><<<>><>><<<>>>><>>><>>><<<>>><<<<>>><>>>><<>>><<<<>>>><<<<>>>><>>><<<><<<<>><<>>><<<>>><<>>><<><<<>>>><><<>><<>>><<<<>><>>>><<>><><<<<>>><><<<><><<>>>><<<>>><<<<>>>><<>>><<><<>>><<>><>><<>>><<<<>>>><<<<>>>><>>><<<<><<>><<<<><<>><<<>><<<<><<>>><<<<>>><<<><<<<>>>><<<<>>>><>>><<<<>>><>>><>><<<<>><<<>>><<>>>><>>>><<<<>>><>><><>>>><><>><>>><<<<>><<<<>>>><<<<><><<<>><<>>><<<>><<<><<<<>><>>>><<><<<><>>><><<<<>>><<>>>><>>>><<<>>>><<<><>>><<<>><<<<>>><<<>>><<<>>>><<>><>>><><<<<><<>>><>>>><<<>>>><>><<><<<>><<<>>><<>>>><>>><<>>>><>><<>><>>><<>><<>>>><<<<>>><<><<><<<<>>><<<>>><<><<>>><<>>>><<<>><<<>>>><>>><<>>><<<>>>><>>><>>><<><>>><<>>>><<>><>>><><<>>><<<<>>>><<<<>>><<>><<>>><<<<><>><<>>><<>>><><<<<><>><<<<><<>>><<>>>><<<<>>>><>>><<<>>>><>>><<<<>><>><>><><><>>><>><<<<><<<><<<<>>>><<><<>><>><<<>><<<<>><>>>><><<<<>>><<><>>><<<<><<<<><<<><<<>>><<<>>><>>>><<<>><<<<><<<<>>><>><<<<>>>><>>><<><<<>>>><<<>>>><<<><<<>><<>>><<<<>>><<<<>>>><<>>><>>>><>>><<<<><<>><>>><<>>><<<><<>>>><<>>><<<<><>>>><<<<>>><<><<<><<<><<<<>>><<<<>><<<<>><<<>><<<<>>>><>>><>>><<><<<<>>>><<<<>><>>><>>>><<<>><<>>>><><<>>>><<<>>>><<<>><<<>><<<<>>>><<<<><<<><<>>>><>>>><>><<><<>>><<<><<>>>><<>>><<>>>><<<<>>>><<<<><<<<>>><><>>><<<<>><<<<>><>>>><<>><>>>><<<<>>>><<<<>><<<><><<<<>>><<<<>>><>><>>><<>><<<>>><<<<>><<<<>>>><<<><<<<><<<<>>><<<<>><<<>>>><<<<>><>>><<>>>><<>>><<<<>>><<<<><<<><<<<>>>><<<>><<<>><>>>><<<<>>>><<<><<<>>>><<<><<<<>>><>>><>>>><<<>>><<<<>>><><<<>>>><<<<>><<>>>><>>><<<<>><<<<>>>><<<>>><>>><>>><<<<>><<<<>>>><<>>><<<<>><<<<>>><<<><<>><<<<>>><<<<>>>><>>>><>>><<>>>><<<<><<<>><<><<>>>><<>><<<<>><><><<<<>>>><<>><<>>><<<<>><><<<<><<<<>>>><<<>>>><<><<<<>><<>>>><<<>>><<<<><<<<><<<<>>><<<<>><><<<><<<<><<<><<>><<<<>><>>>><<<><>>>><<<<><<>>>><>><>>><<<><<><<<<>>><<<>>>><<<>>><<>><<<<><<>>><<>>><<<<>>><<<>>>><<>>>><<>>><<<>>>><>>>><<<<><<<<>>>><<<><<<><>>>><<<<><><<<><<<><<<<>><<<<>>><><<<<>>><<>>>><<><><<><<<<>>>><<><<><<<>>>><<><<>><>>><<<<><<><<<<>>>><<<><<<><<<<><>>><<<>><>>><<><<><<<>><<<><<<<><><>>><><><<<>><<<>>>><<<>><>><<>>>><>><<>><<><>><<><<<>><<<>>><<>><>><<<<>>>><<<<><<><<<>>><<<<>>><>>>><<<>><<<<>><<<<>>><><<<>><>><<<<><<<>>>><<<<>><>><<<<>><<>>>><<<<>>>><<><<<<>><<<>><>><><<<<>><>><<>>><>>><<>><<<><<>>><<>>><>>><>>>><<<>>>><<<<>><<<<>>>><><<<<><<><<<><<>>>><<>>><<<<>>><<<><<<>><>><>><<>><<<>>><><<>><<<<>>>><<>><<<<>>>><<><<<>>><<<<><<<<>>>><>>><<<<>><<<>>><<<><>><><<<>><<>>>><><<>>><<<<>><>>>><<<<><<<<>>><<<<>>>><<<>><<<<><>><><<>><<<>>><<<><>><<>>><<<<>>><<>>><>>><<<<>><<>>>><>>><>><<<>><<<>>>><<>>>><<<><<>>>><<<<><<<<><<<>><<<><<<<>>>><<<>><>>><<<>>><<<>><<<<>><<<<>>>><<<<><<>>><<>><>>><<<>><<<<><<>><<>>><<><<<><<<<>>>><<<<>>><<<>>>><>><<<><<<<>>><<<>>><<>><>><>><<<<>>>><<>>><<>><<>><>><<<<><<>><<<><<<><<<<>><>>>><<<>>><>><<<<>><<<><>>>><>><>><<><<>>><>>><>>>><<<>>><<<<><<<<><<>>><<<>>><><><<<>>><<<>>><<<<>>><><<<<>>><<<>>><>>>><<<<>>><<>>><<><<<>>>><<<>><<<<>>>><<>><>>>><<><>><<<>>>><<<<><>>>><<<>>>><<<<>>><><<><<<>><>>><<<>><<<<>>><><><<>>><<<<>><>><<<<><>>><<>>><<<<><<<<>><>>>><<><<>><<<<>>><<<>><<>>><>>>><>>>><<>>>><<<<>>><<<<><<<><><<<<>>><<>><<<>>>><<><<<>><>>><<>>>><<<<>><<><<<<>>><<>><<<<><<<>><<<>>><<>><<<<><<<<>>><<<<>><<<<>>><<>>>><<<>>><<<<>><<<<><>>>><<><<>>><<>>><<<<>><>><<<<>><<<<><<>>><<<>><<<<>>><<<>>><<<<>>>><<<<>>>><<<><>>><<>>><<>><<>>><>><<<>>><<<><>>>><<><<<>><<<<>><<<>><>><>>>><<<<><<<>>><>><>><<>>>><<<>><>>>><<>>><<>><<>><<<<>><<<>>>><>>><<<>>><>>><<<<>><<<<><>><<>>>><<<<>>>><<<<>>>><>>><<<>><<<<>>>><<>>>><<>>>><<<>><<<><<<>>><<<><>>><<<>>><<>>><<<<>>>><>>><<<<>><<<>>><<>>>><<<<><<<<><<><>><<<>><>><>><<<><<<>>><>>><><<<>>><>>>><<>>><<>>>><<>>><<<<>><<>>><<<><<><>><<<<>><>>><<<<>>>><>><<<>><<<<>>>><<><<<<>>><<<>><<<>><<<<>>><>><<<>><<<<>>>><>><<<><<>><>>><<<<>>><<<>>>><><<<><<<>>>><<>>>><<><<<><<<>>><<><<<<>>><<<<>>>><>>><><>>>><<<>>><>><<<<>>>><>>>><>><<<<>>>><<<<>>><>>>><<>>>><<><<<<><<>>>><<<>><<<>>>><<><<<>>><<><><<><<<<>>><<>>><<<>>><<<<>><<>>><<<<>><<<><<>>>><<<><>>><<>>>><<<><<<>>><<>>>><<<<>><>>><>>>><<<<>>>><<<>>>><<<>>><>><<<>>><<<<>><><<><>><><>><<>>><<>>>><<<<>>><<<>><<<>><<<><>><<<>>>><<><>><>>>><<<<>>>><<>><<><<<>><<<>><>>>><<>><<<<><<<<><<<><<<>>><<<>>><>><<<<><<<<>>><<<>>>><<>><<<<>>><<<>>><>>>><>>>><><<<<>><<>>><<>>>><<<<><<>>>><<<>>><<<>><<><<<>>>><<<>>><<<>>><><>><<<>><<<<>>>><<<<>>><<<<><<>>>><<<<><<<>>>><<<<>><<<<><>><<>>>><><>>>><<<<>>>><<<>><<<>><<<<>>><<>><<<<>><>><<>>><<<>>>><<<<>>><<<<>>><<><<<<>>>><><<>>><<>>>><<<><<><>>>><<>>>><<>><<<<><>><<>>><><<<<>>><<<<>><>>><<<>><<>>>><<>>><<<>><<><<>>><<<>>>><><><<<>><><>>>><>>><<<<><<<>>><>><<<<><<>>>><<<<>><<<><<<<>>>><>>><>><<<<>><<<<>>>><<<<>>>><<<<>>><>>><<<>>>><<<>><<>>>><<<>>>><<<<>>>><<<<>><>><<<<>><<<<>>><<<<>>><<<><<<>><<>><<<<>>>><<<<>>><<<>><>>>><<<>>>><<><>><<<<><<<<><<>>>><<>>><<<>>><<<><<>><><<<<>><>>>><>>><<<>>><><<<><<>>>><<<<>>><<>>><<>><<>><<<<>>>><<>>><>>><>><<>><<<>>><<>><>>>><<<><>><<<<>>>><><<>>>><<<><<>>><><<<<>>>><<<><<<>>><<<>>><<<<>>>><<<<>>><<<><<>>><>>><<>>>><><>>><<<<>>>><>>>><<<>>>><<<<>><<<><>>><<<<>>><>><<>>>><<>>>><<>>><<>>><<<>>>><<<<>><>>><<>>><<>><<<>>><<<><<<>><<>><>>><<<<><<<<>>><<><<<>>><<<>>><<><<<<>><><<<<>>><>><<<<><<>><<>>>><<<<><<<<>>>><<<>><<<<>>><<<<>>>><<<>>><>>><<<<>>>><<><<<><<>>><<<<><<<<>><<<<>><<<<>><<<";

    /// <inheritdoc />
    public string Description()
    {
        return "Pyroclastic Flow [HARD]";
    }

    /// <inheritdoc />
    public int SortOrder()
    {
        return 17;
    }

    /// <inheritdoc />
    public string PartA()
    {
        var max = RunSimulationAndCalculateHighestY(ActualInput, 2022);

        return max.ToString();
    }

    /// <inheritdoc />
    public string PartB()
    {
        var max = RunBigSimulationAndCalculateHighestY(ActualInput, 1000000000000);

        return max.ToString();
    }

    public long RunSimulationAndCalculateHighestY(string input, long numShapes)
    {
        var instructions = input.ToCharArray().ToList();
        var pit = new Pit(0, 8, 0, instructions);

        for (long i = 0; i < numShapes; i++)
        {
            pit.PlayShapeOut();
        }

        return pit.YCeiling;
    }

    public long RunBigSimulationAndCalculateHighestY(string input, long numShapes)
    {
        var instructions = input.ToCharArray().ToList();
        var pit = new Pit(0, 8, 0, instructions);

        // Number will be giant, so we need to look for a repeat pattern, which we can do by keeping
        // a dictionary of a combination of the instruction pointer and the ending X position of the shape
        // but will need the numShape count and YCeiling to calculate the true interval
        var lookForRepeat = new Dictionary<string, (long, long)>();
        long amountToAdd = 0;

        for (long i = 0; i < numShapes; i++)
        {
            pit.PlayShapeOut();

            // Pattern is the instruction pointer and the index of the shape
            var patternIndex = $"{pit.GetPointer}-{i % 5}";
            if (lookForRepeat.ContainsKey(patternIndex) && amountToAdd == 0 && i >= 2022)
            {
                // We found repeat, now do some math
                var (oldI, oldYCeiling) = lookForRepeat[patternIndex];
                var deltaY = pit.YCeiling - oldYCeiling;
                var deltaI = i - oldI;
                var times = (numShapes - i) / deltaI;
                amountToAdd = times * deltaY;

                // Update our index so we "jump" to the end, minus the remainder
                i += times * deltaI;
            }

            lookForRepeat[patternIndex] = (i, pit.YCeiling);
        }

        return pit.YCeiling + amountToAdd;
    }
}